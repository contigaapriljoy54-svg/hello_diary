<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Diary Dashboard</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Georgia', serif;
  background:#d8c3a5;
  background-size: cover;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  padding-top: 50px;
}

#logoutBtn {
  position: fixed;
  top: 15px;
  left: 15px;
  background: linear-gradient(135deg, #a47148, #6f4e37);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s ease;
  z-index: 1000;
}

#logoutBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

h2 {
  color: #5a3e2b;
  font-size: 2rem;
  margin-bottom: 20px;
}

.container {
  position: relative;
  z-index: 10;
  background: rgba(255, 248, 240, 0.88);
  backdrop-filter: blur(8px);
  padding: 30px;
  border-radius: 18px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  width: 90%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid rgba(255,255,255,0.4);
}

textarea {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #d8c3a5;
  font-size: 1rem;
  resize: none;
  background-color: #fffdf9;
  transition: 0.3s ease;
}

textarea:focus {
  outline: none;
  border-color: #a47148;
  box-shadow: 0 0 8px rgba(164, 113, 72, 0.4);
}

button.add {
  margin-top: 15px;
  padding: 12px;
  background: linear-gradient(135deg, #a47148, #6f4e37);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s ease;
  font-size: 1rem;
}

button.add:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.note {
  background: #fff;
  padding: 10px;
  margin-top: 10px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.note .date {
  font-size: 0.8rem;
  color: #555;
  margin-bottom: 5px;
  font-style: italic;
}

.note span {
  width: 100%;
  word-break: break-word;
  white-space: pre-wrap;
  margin-bottom: 10px;
}

.note .button-container {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.note button.edit {
  padding: 8px 14px;
  font-size: 1rem;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg, #ffd966, #e0a800);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.note button.edit:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35), 0 0 10px rgba(255,255,255,0.2);
}

.note button.delete {
  padding: 8px 14px;
  font-size: 1rem;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg, #ff6b6b, #dc3545);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}

.note button.delete:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35), 0 0 10px rgba(255,255,255,0.2);
}

@media(max-width: 500px) {
  .note {
    flex-direction: column;
    align-items: flex-start;
  }
  .note .button-container {
    flex-direction: row;
    flex-wrap: wrap;
  }
}
</style>
</head>

<body>
<button id="logoutBtn">Logout</button>
<h2>Write Something About Your Day</h2>

<div class="container">
  <textarea id="noteContent" rows="3" placeholder="Write your note here..."></textarea>
  <button class="add" id="addBtn">Add Note</button>
  <div id="notesContainer"></div>
</div>
<script>
const userId = localStorage.getItem('userId');
if (!userId) {
  window.location.href = 'login.html';
}

const notesContainer = document.getElementById('notesContainer');
const addBtn = document.getElementById('addBtn');
const noteContent = document.getElementById('noteContent');
const logoutBtn = document.getElementById('logoutBtn');

const BASE_URL = 'https://hellodiary-production.up.railway.app';

logoutBtn.addEventListener('click', () => {
  localStorage.clear();
  window.location.href = 'login.html';
});

async function loadNotes() {
  try {
    const res = await fetch(`${BASE_URL}/notes/${userId}`);
    if (!res.ok) throw new Error('Failed to load notes');

    const notes = await res.json();
    notesContainer.innerHTML = '';

    notes.forEach(note => {
      const div = document.createElement('div');
      div.className = 'note';

      const dateText = note.createdAt
        ? new Date(note.createdAt).toLocaleString()
        : 'Date not available';

      div.innerHTML = `
        <div class="date">${dateText}</div>
        <span>${note.content}</span>
        <div class="button-container">
          <button class="edit">Edit</button>
          <button class="delete">Delete</button>
        </div>
      `;

      const editBtn = div.querySelector('.edit');
      const deleteBtn = div.querySelector('.delete');
      const contentSpan = div.querySelector('span');
      const buttonContainer = div.querySelector('.button-container');

      editBtn.onclick = () => {
        if (div.classList.contains('editing')) return;
        div.classList.add('editing');

        const originalContent = contentSpan.textContent;

        const textarea = document.createElement('textarea');
        textarea.value = originalContent;
        textarea.rows = 3;
        textarea.style.width = '100%';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.className = 'edit';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'delete';

        div.replaceChild(textarea, contentSpan);
        buttonContainer.innerHTML = '';
        buttonContainer.append(saveBtn, cancelBtn);

        saveBtn.onclick = async () => {
          const newContent = textarea.value.trim();
          if (!newContent) return alert('Note cannot be empty');

          const res = await fetch(`${BASE_URL}/notes/${userId}/${note.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent }),
          });

          if (!res.ok) {
            alert('Failed to update note');
            return;
          }

          loadNotes();
        };

        cancelBtn.onclick = () => {
          loadNotes();
        };
      };

      deleteBtn.onclick = async () => {
        if (!confirm('Delete this note?')) return;

        const res = await fetch(`${BASE_URL}/notes/${userId}/${note.id}`, {
          method: 'DELETE',
        });

        if (!res.ok) {
          alert('Failed to delete note');
          return;
        }

        loadNotes();
      };

      notesContainer.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    alert('Error loading notes');
  }
}

addBtn.addEventListener('click', async () => {
  const content = noteContent.value.trim();
  if (!content) return alert('Note cannot be empty');

  const createdAt = new Date().toISOString();

  try {
    const res = await fetch(`${BASE_URL}/notes/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: Number(userId),
        title: 'Note',
        content,
        createdAt,
      }),
    });

    if (!res.ok) throw new Error('Failed to add note');

    noteContent.value = '';
    loadNotes();
  } catch (err) {
    console.error(err);
    alert('Failed to add note');
  }
});

loadNotes();
</script>
</body>
</html>